tosca_definitions_version: tosca_simple_yaml_1_3

capability_types:

  sodalite.capabilities.modak.JobOptions:
    derived_from: tosca.capabilities.Root

  sodalite.capabilities.modak.Application:
    derived_from: tosca.capabilities.Root

  sodalite.capabilities.modak.ApplicationBuild:
    derived_from: tosca.capabilities.Root
    
  sodalite.capabilities.modak.Target:
    derived_from: tosca.capabilities.Root
    
  sodalite.capabilities.modak.Optimization:
    derived_from: tosca.capabilities.Root
    

node_types:

  # here we can have the playbook that directly interfaces MODAK (src/docker)
  # and then proceed with the normal job workflow from HPC examples
  sodalite.nodes.modak.job:
    derived_from: tosca.nodes.Root
    properties:
      artifact_name:
        type: string
      artifact_url:
        type: string
    dependencies:
      - job_options:
          node: sodalite.nodes.modak.job_options
          capability: sodalite.capabilities.modak.JobOptions
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
      - application:
          node: sodalite.nodes.modak.application
          capability: sodalite.capabilities.modak.Application
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
      - target:
          node: sodalite.nodes.modak.target
          capability: sodalite.capabilities.modak.Target
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
      - optimization:
          node: sodalite.nodes.modak.optimization
          capability: sodalite.capabilities.modak.Optimization
          relationship: tosca.relationships.DependsOn
          occurrences: [ 0, 1 ]


  sodalite.nodes.modak.job_options:
    derived_from: tosca.nodes.Root
    properties:
      job_name:
        type: string
      account:
        type: string
        required: false
      queue:
        type: string
      wall_time_limit:
        type: string
      node_count:
        type: integer
      core_count:
        type: integer
      process_count_per_node:
        type: integer
        required: false
      core_count_per_process:
        type: integer
        required: false
      memory_limit:
        type: scalar-unit.size
        required: false
      minimum_memory_per_processor:
        type: scalar-unit.size
        required: false
      request_gpus:
        type: integer
        required: false
      request_specific_nodes:
        type: string
        required: false
      job_array:
        type: string
        required: false
      standard_output_file:
        type: string
      standard_error_file:
        type: string
      combine_stdout_stderr:
        type: boolean
      architecture_constraint:
        type: string
        required: false
      copy_environment:
        type: boolean
        required: false
      copy_environment_variable:
        type: string
        required: false
      job_dependency:
        type: string
        required: false
      request_event_notification:
        type: string
        required: false
      email_address:
        type: string
        required: false
      defer_job:
        type: string
        required: false
      node_exclusive:
        type: boolean
        required: false
    capabilities:
      job_options:
        type: sodalite.capabilities.modak.JobOptions
        valid_source_types: [ sodalite.nodes.modak.job ]

  sodalite.nodes.modak.application.build:
    derived_from: tosca.nodes.Root
    properties:
      source:
        type: string
      build_command:
        type: string
    capabilities:
      build:
        type: sodalite.capabilities.modak.ApplicationBuild
        valid_source_types: [ sodalite.nodes.modak.application ]

  sodalite.nodes.modak.application:
    derived_from: tosca.nodes.Root
    properties:
      app_tag:
        type: string
      container_runtime:
        type: string
      app_type:
        type: string
      executable:
        type: string
      arguments:
        type: string
      mpi_ranks:
        type: integer
        required: false
      threads:
        type: integer
        required: false
    capabilities:
      application:
        type: sodalite.capabilities.modak.Application
        valid_source_types: [ sodalite.nodes.modak.job ]
    requirements:
      - build:
          node: sodalite.nodes.modak.application.build
          capability: sodalite.capabilities.modak.ApplicationBuild
          relationship: tosca.relationships.DependsOn
          occurrences: [ 0, UNBOUNDED ]

  sodalite.nodes.modak.target:
    derived_from: tosca.nodes.Root
    properties:
      name:
        type: string
      queue_type:
        type: string
    capabilities:
      target:
        type: sodalite.capabilities.modak.Target
        valid_source_types: [ sodalite.nodes.modak.job ]

  # It is part of Optimization DSL
  # It is here for completeness
  sodalite.nodes.modak.optimization:
    derived_from: tosca.nodes.Root
    capabilities:
      optimization:
        type: sodalite.capabilities.modak.Optimization
        valid_source_types: [ sodalite.nodes.modak.job ]
